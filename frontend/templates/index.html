<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SpeedyFlow - JIRA Service Desk Integration Platform">
  <meta name="theme-color" content="#ffffff">
  <title>SpeedyFlow - Ticket Management</title>
  
  <!-- ============================================================
       CSS LOADING STRATEGY
       ============================================================
       1. Theme blocker loads first (prevents flash)
       2. app.bundle.css imports all production CSS in order:
          - Foundation (design tokens, variables, layout)
          - Themes (light/dark/transparency)
          - Components (UI elements)
          - Layout (structure)
          - Utilities (interactive features)
          - Fallback (legacy support)
       ============================================================ -->
  
  <!-- THEME BLOCKER: Prevents flash by applying theme BEFORE CSS renders -->
  <script src="/static/js/theme-blocker.js"></script>
  
  <!-- PRIMARY CSS BUNDLE: All production styles orchestrated -->
  <link rel="stylesheet" href="/static/css/app.bundle.css?v={{ timestamp }}">
  
  <!-- SVG ICONS STYLES: Centralized icon styling -->
  <link rel="stylesheet" href="/static/css/utils/svg-icons.css?v={{ timestamp }}">
  
  <!-- BOARD VIEW STYLING (Kanban) -->
  <link rel="stylesheet" href="/static/views/board/kanban.css?v={{ timestamp }}">
  
  <!-- LIST VIEW STYLING -->
  <link rel="stylesheet" href="/static/views/list/list-view.css?v={{ timestamp }}">
  
  <!-- DRAG & DROP TRANSITIONS STYLING -->
  <link rel="stylesheet" href="/static/views/board/transition-bar-vertical.css?v={{ timestamp }}">
  <link rel="stylesheet" href="/static/views/list/transition-bar-horizontal.css?v={{ timestamp }}">
  <link rel="stylesheet" href="/static/css/components/transition-fields-modal.css?v={{ timestamp }}">
  
  <!-- QUICK ACTIONS STYLING (Quick Triage & Smart Filters) -->
  <link rel="stylesheet" href="/static/css/components/quick-actions.css?v={{ timestamp }}">
  
  <!-- AUTO-SWITCH NOTIFICATION STYLING -->
  <link rel="stylesheet" href="/static/css/components/auto-switch-notification.css?v={{ timestamp }}">
  
  <!-- ML FEATURES STYLING -->
  <link rel="stylesheet" href="/static/css/ml-features.css?v={{ timestamp }}">
  
  <!-- FLOWING MVP STYLING -->
  <link rel="stylesheet" href="/static/flowing-mvp/css/footer.css?v={{ timestamp }}">
  <link rel="stylesheet" href="/static/flowing-mvp/css/flowing-context-aware.css?v={{ timestamp }}">
  
  <!-- INLINE STYLES FOR SIDEBAR ACTION BUTTON -->
  <style>
    /* PERFECT ALIGNMENT: All sidebar components align with header/filter/board */
    
    /* Sidebar Header: Align with header-enhanced top */
    .sidebar-header-component {
      top: 16px !important; /* Same as header margin */
      left: 16px !important;
      margin: 0 !important;
    }
    
    /* Action Button: Position between header and filter */
    #sidebarActionComponent {
      top: 112px !important; /* After header total height (16 + 12 + 56 + 12 + 16) */
      left: 16px !important;
      width: 280px !important;
      min-height: 56px !important;
      height: 56px !important;
      padding: 12px 14px !important; /* Same as sidebar-header-component */
      margin: 0 !important;
      box-sizing: border-box !important;
    }
    
    /* Quick Action Button: Match sidebar-toggle-btn exactly */
    #quickActionBtn {
      background: linear-gradient(135deg, rgb(59, 130, 246), rgb(37, 99, 235)) !important;
      width: 40px !important;
      height: 40px !important;
      min-width: 40px !important;
      min-height: 40px !important;
      border-radius: 10px !important;
      font-size: 22px !important; /* Slightly larger icon */
      padding: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      border: none !important;
    }
    
    #quickActionBtn .toggle-icon {
      font-size: 22px !important; /* Match button font-size */
      line-height: 1 !important;
      display: block !important;
    }
    
    #quickActionBtn:hover {
      background: linear-gradient(135deg, rgb(37, 99, 235), rgb(29, 78, 216)) !important;
      transform: scale(1.05) !important;
    }
    
    /* Sidebar Content: Align with kanban board start */
    .sidebar-content-component {
      top: 206px !important; /* After header (112px) + filter (94px) = 206px */
      left: 16px !important;
      height: calc(100vh - 222px) !important; /* 206px + 16px bottom margin */
      margin: 0 !important;
    }
  </style>
  
  <!-- DEBUG SCRIPT: Force button visibility -->
  <script>
    console.log('ðŸ” DEBUG: Initializing sidebar action button...');
    document.addEventListener('DOMContentLoaded', function() {
      // Inject SVG icons into sidebar menu
      if (typeof SVGIcons !== 'undefined') {
        // Main navigation icons (16px for sidebar)
        const iconMappings = {
          'icon-new-ticket': SVGIcons.plus({ size: 16 }),
          'icon-my-tickets': SVGIcons.folder({ size: 16 }),
          'icon-all-tickets': SVGIcons.clipboard({ size: 16 }),
          'icon-starred': SVGIcons.star({ size: 16 }),
          // Utilities icons
          'icon-search': SVGIcons.search({ size: 16 }),
          'icon-reports': SVGIcons.chart({ size: 16 }),
          'icon-notifications': SVGIcons.bell({ size: 16 }),
          'icon-refresh': SVGIcons.refresh({ size: 16 }),
          'icon-clear-cache': SVGIcons.trash({ size: 16 })
        };
        
        Object.keys(iconMappings).forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = iconMappings[id];
          }
        });
        
        // Header icons (18px for header)
        const headerIconMappings = {
          'icon-header-help': SVGIcons.help({ size: 18 }),
          'icon-header-settings': SVGIcons.settings({ size: 18 }),
          'icon-header-user': SVGIcons.user({ size: 18 })
        };
        
        Object.keys(headerIconMappings).forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = headerIconMappings[id];
          }
        });
        
        // ML Dashboard tab icons (20px for tabs)
        const mlIconMappings = {
          'icon-ml-overview': SVGIcons.chart({ size: 20 }),
          'icon-ml-forecast': SVGIcons.alert({ size: 20 }),
          'icon-ml-trends': SVGIcons.trendUp({ size: 20 }),
          'icon-ml-team': SVGIcons.users({ size: 20 })
        };
        
        Object.keys(mlIconMappings).forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = mlIconMappings[id];
          }
        });
        
        // Filter bar icons (16px for filter labels)
        const filterIconMappings = {
          'icon-filter-desk': SVGIcons.building({ size: 16 }), // Organization/building icon
          'icon-filter-queue': SVGIcons.clipboard({ size: 16 }),
          'icon-filter-view': SVGIcons.eye({ size: 16 }),
          'icon-view-board': SVGIcons.chart({ size: 18 }),
          'icon-view-list': SVGIcons.list({ size: 18 }) // Proper list icon
        };
        
        Object.keys(filterIconMappings).forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = filterIconMappings[id];
          }
        });
        
        // Right sidebar detail icons (16px)
        const sidebarDetailIconMappings = {
          'icon-ticket-info': SVGIcons.clipboard({ size: 16 }),
          'icon-tab-essential': SVGIcons.star({ size: 16 }),
          'icon-tab-details': SVGIcons.clipboard({ size: 16 }),
          'icon-tab-technical': SVGIcons.settings({ size: 16 })
        };
        
        Object.keys(sidebarDetailIconMappings).forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = sidebarDetailIconMappings[id];
          }
        });
        
        console.log('âœ… All SVG icons injected (sidebar, header, ML dashboard, filter bar, right sidebar)');
      } else {
        console.warn('âš ï¸ SVGIcons not loaded, sidebar icons will not render');
      }
      
      setTimeout(function() {
        const sidebarContent = document.querySelector('.sidebar-content-component');
        const actionComponent = document.querySelector('.sidebar-action-component');
        const actionBtn = document.getElementById('quickActionBtn');
        
        console.log('ðŸ“ Sidebar content:', sidebarContent);
        console.log('ðŸ“ Action component:', actionComponent);
        console.log('ðŸ”˜ Action button:', actionBtn);
        
        if (sidebarContent && actionComponent) {
          // Sync collapsed state with sidebar
          if (sidebarContent.classList.contains('collapsed')) {
            actionComponent.classList.add('collapsed');
            console.log('ðŸ”„ Sidebar is collapsed, syncing action button');
          } else {
            actionComponent.classList.remove('collapsed');
            console.log('âœ… Sidebar is expanded, action button ready');
          }
        }
        
        // Listen for sidebar toggle events
        window.addEventListener('sidebarToggled', function() {
          console.log('ðŸ”” Sidebar toggled event received');
          if (sidebarContent && actionComponent) {
            if (sidebarContent.classList.contains('collapsed')) {
              actionComponent.classList.add('collapsed');
            } else {
              actionComponent.classList.remove('collapsed');
            }
          }
        });
        
        console.log('âœ… Sidebar action button initialized');
      }, 100);
    });
  </script>
  
  <!-- Chart.js for interactive charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- USER SETUP MODAL (First-time configuration) -->
  <link rel="stylesheet" href="/static/css/user-setup-modal.css?v={{ timestamp }}">
  

  <!-- FOOTER V2 STYLES -->
  <link rel="stylesheet" href="/static/css/components/footer-v2.css?v={{ timestamp }}">
</head>
<body class="theme-light">
  <script>
    console.log('ðŸš€ BODY LOADED - Checking for sidebar-action-component...');
    console.log('ðŸ“ Elements in DOM:', document.querySelectorAll('aside').length, 'asides found');
  </script>
  
  <div class="app-container" role="application" aria-label="SpeedyFlow Ticket Workspace">
    <!-- SIDEBAR (UNIFIED REBUILD) -->
    <!-- SIDEBAR HEADER (Toggle Button) -->
    <aside class="sidebar-header-component" role="banner" aria-label="Sidebar Toggle">
      <button id="sidebarToggleBtn" class="sidebar-toggle-btn" aria-label="Toggle Sidebar">
        <span class="toggle-icon">â˜°</span>
      </button>
    </aside>

    <!-- SIDEBAR ACTION BUTTON (Clone of header style) -->
    <aside class="sidebar-header-component" id="sidebarActionComponent" role="complementary" aria-label="Quick Actions" style="top: 112px !important;">
      <button id="quickActionBtn" class="sidebar-toggle-btn" aria-label="Quick Action" title="Quick Action">
        <span class="toggle-icon">âš¡</span>
      </button>
    </aside>

    <!-- SIDEBAR CONTENT (Navigation Menu) -->
    <aside class="sidebar-content-component" role="navigation" aria-label="Primary Navigation">
      <div class="sidebar-content">
        <section class="sidebar-section" aria-label="Navigation">
          <span class="sidebar-section-label">Navigation</span>
          <nav class="sidebar-menu" aria-label="Main">
            <button type="button" id="newTicketBtn" class="sidebar-menu-item" aria-label="Create Ticket" data-tooltip="Create Ticket"><span class="icon" id="icon-new-ticket"></span><span class="label">Create Ticket</span></button>
            <a href="#" class="sidebar-menu-item active" aria-current="page" data-tooltip="My Tickets"><span class="icon" id="icon-my-tickets"></span><span class="label">My Tickets</span></a>
            <a href="#" class="sidebar-menu-item" data-tooltip="All Tickets"><span class="icon" id="icon-all-tickets"></span><span class="label">All Tickets</span></a>
            <a href="#" class="sidebar-menu-item" data-tooltip="Starred"><span class="icon" id="icon-starred"></span><span class="label">Starred</span></a>
          </nav>
        </section>
        <div class="sidebar-divider" aria-hidden="true"></div>
        <section class="sidebar-section" aria-label="Utilities">
          <span class="sidebar-section-label">Utilities</span>
          <nav class="sidebar-menu" aria-label="Utilities">
            <a href="#" class="sidebar-menu-item" data-tooltip="Search"><span class="icon" id="icon-search"></span><span class="label">Search</span></a>
            <a href="#" class="sidebar-menu-item" data-tooltip="Reports"><span class="icon" id="icon-reports"></span><span class="label">Reports</span></a>
            <button type="button" class="sidebar-menu-item" id="notificationsBtn" aria-label="Notifications" data-tooltip="Notifications">
              <span class="icon" id="icon-notifications"></span>
              <span class="label">Notifications</span>
              <span class="notification-badge" style="display: none;">0</span>
            </button>
            <button type="button" class="sidebar-menu-item" id="refreshBtn" aria-label="Refresh" data-tooltip="Refresh"><span class="icon" id="icon-refresh"></span><span class="label">Refresh</span></button>
            <button type="button" class="sidebar-menu-item" id="clearCacheBtn" aria-label="Clear Cache" title="Clear local cache to force refresh" data-tooltip="Clear Cache"><span class="icon" id="icon-clear-cache"></span><span class="label">Clear Cache</span></button>
          </nav>
        </section>
        <div class="sidebar-divider" aria-hidden="true"></div>
      </div>
    </aside>

    <!-- MAIN WRAPPER -->
    <div class="main-wrapper" role="main">

      <header class="header-enhanced" aria-label="Primary">
        <div class="header-left-section">
          <div class="header-brand">
            <span class="brand-icon">âš¡</span>
            <span class="brand-text">SpeedyFlow</span>
          </div>
          <div class="header-divider-vertical"></div>
          <h1 class="header-page-title">
            <span class="page-title-text">Tickets</span>
          </h1>
        </div>
        
        <div class="header-center-section">
          <nav aria-label="Breadcrumb" class="breadcrumb-enhanced">
            <span class="breadcrumb-item" id="deskBreadcrumb">Select Desk</span>
            <span class="breadcrumb-separator" aria-hidden="true">â€º</span>
            <span class="breadcrumb-item" id="queueBreadcrumb">Select Queue</span>
          </nav>
        </div>
        
        <div class="header-right-section">
          <div class="header-status-badge">
            <span class="status-indicator"></span>
            <span class="status-text" id="filterStatus">Ready</span>
          </div>
          <div class="header-divider-vertical"></div>
          <div class="header-account-actions">
            <button class="header-icon-btn" id="headerHelpBtn" title="Help Center" aria-label="Help Center">
              <span class="icon" id="icon-header-help"></span>
            </button>
            <button class="header-icon-btn" id="headerSettingsBtn" title="Settings" aria-label="Settings">
              <span class="icon" id="icon-header-settings"></span>
            </button>
            <button class="header-icon-btn" id="headerUserMenuBtn" title="Profile" aria-label="Profile">
              <span class="icon" id="icon-header-user"></span>
            </button>
          </div>
        </div>
      </header>

      <div class="filter-bar-enhanced" aria-label="Filters">
        <!-- Primary Filters -->
        <div class="filter-section filter-primary">
            <div class="filter-group">
              <label for="serviceDeskSelectFilter" class="filter-label">
                <span class="filter-icon" id="icon-filter-desk"></span>
                <span class="filter-text">Service Desk</span>
              </label>
              <div class="filter-input-wrapper">
                <select id="serviceDeskSelectFilter" class="filter-select">
                  <option value="">Select Desk...</option>
                </select>
                <span class="filter-dropdown-icon">â–¼</span>
              </div>
            </div>
            
            <div class="filter-group">
              <label for="queueSelectFilter" class="filter-label">
                <span class="filter-icon" id="icon-filter-queue"></span>
                <span class="filter-text">Queue</span>
              </label>
              <div class="filter-input-wrapper filter-with-action">
                <select id="queueSelectFilter" class="filter-select">
                  <option value="">Select Queue...</option>
                </select>
                <span class="filter-dropdown-icon">â–¼</span>
                <button id="saveFiltersBtn" class="filter-action-btn" title="Save current filters">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H7V5h8v4z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="filter-divider"></div>

          <!-- View Controls -->
          <div class="filter-section filter-controls">
            <div class="filter-group">
              <label class="filter-label">
                <span class="filter-icon" id="icon-filter-view"></span>
                <span class="filter-text">View Mode</span>
              </label>
              <div class="view-toggle-enhanced" role="tablist">
                <button class="view-btn active" data-view="kanban" aria-selected="true" role="tab">
                  <span class="view-icon" id="icon-view-board"></span>
                  <span class="view-text">Board</span>
                </button>
                <button class="view-btn" data-view="list" role="tab">
                  <span class="view-icon" id="icon-view-list"></span>
                  <span class="view-text">List</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="filter-divider"></div>

          <!-- Theme Controls -->
          <div class="filter-section filter-theme">
            <div class="filter-group">
              <label class="filter-label">
                <span class="filter-icon">âœ¨</span>
                <span class="filter-text">Customize</span>
              </label>
              <div class="theme-controls">
                <button id="bgSelectorHeaderBtn" class="theme-btn" title="Change background">
                  <span class="theme-btn-icon">ðŸŽ¨</span>
                  <span class="theme-btn-text">Background</span>
                </button>
                <button id="themeToggleBtn" class="theme-btn" title="Toggle theme">
                  <span class="theme-btn-icon">ðŸŽ­</span>
                  <span class="theme-btn-text">Theme</span>
                </button>
              </div>
            </div>
          </div>
        </div>

      <div class="board-wrapper" id="boardWrapper">
        <div id="kanbanView" class="kanban-board" aria-live="polite">
          <div class="placeholder-pro" id="kanbanPlaceholder">Loading tickets...</div>
        </div>
        <div id="listView" class="list-view" style="display:none" aria-live="polite">
          <div class="placeholder-pro" id="listPlaceholder">Loading tickets...</div>
        </div>
      </div>

      <!-- RIGHT SIDEBAR (TICKET DETAILS) -->
      <div class="right-sidebar" id="rightSidebar" style="display: none; padding-bottom: 70px;">
      <!-- CLOSE BUTTON -->
      <button class="btn-close-sidebar" id="closeSidebarBtn">âœ•</button>

      <!-- TWO COLUMN LAYOUT -->
      <div class="sidebar-two-columns">
        
        <!-- LEFT COLUMN: DETAILS -->
        <div class="sidebar-column sidebar-details">
          <div class="column-header">
            <h3>Ticket Details</h3>
          </div>

          <div class="column-content">
            <!-- SLA MONITOR (First, most important) -->
            <div id="slaMonitorContainer" style="margin-bottom: 12px;">
              <!-- SLA Monitor renders here dynamically -->
            </div>

            <!-- ALL FIELDS (Organized in tabs by importance) -->
            <div class="detail-group detail-group-all-fields">
              <div class="detail-label">
                <span><span id="icon-ticket-info"></span> Ticket Information</span>
              </div>
              
              <!-- TABS NAVIGATION -->
              <div class="fields-tabs">
                <button class="fields-tab active" data-tab="essential">
                  <span id="icon-tab-essential"></span> Essential
                </button>
                <button class="fields-tab" data-tab="details">
                  <span id="icon-tab-details"></span> Details
                </button>
                <button class="fields-tab" data-tab="technical">
                  <span id="icon-tab-technical"></span> Technical
                </button>
              </div>
              
              <!-- TAB CONTENT -->
              <div class="fields-tab-content active" id="tab-essential">
                <!-- Essential fields (populated dynamically) -->
              </div>
              <div class="fields-tab-content" id="tab-details">
                <!-- Detail fields (populated dynamically) -->
              </div>
              <div class="fields-tab-content" id="tab-technical">
                <!-- Technical fields (populated dynamically) -->
              </div>
            </div>

            <!-- ATTACHMENTS SECTION -->
            <div class="detail-group detail-group-attachments" id="attachmentsSection" style="display: none;">
              <div class="detail-label">
                <span>ðŸ“Ž Attachments</span>
                <span class="detail-label-hint" id="attachmentCountLabel">(0)</span>
              </div>
              <div id="existingAttachmentsContainer" class="attachments-display-container">
                <!-- Populated dynamically by right-sidebar.js -->
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: COMMENTS -->
        <div class="sidebar-column sidebar-comments">
          <div class="column-header">
            <h3>Comments <span class="comment-count" id="commentCount">(0)</span></h3>
          </div>

          <div class="column-content">
            <div class="comments-list" id="commentsList">
              <p class="no-comments">Loading comments...</p>
            </div>
          </div>

          <!-- COMMENT INPUT AREA -->
          <div class="comment-input-container">
            <!-- ATTACHMENTS TOOLBAR -->
            <div class="comment-toolbar">
              <button class="comment-toolbar-btn" id="attachBtn" title="Attach file">
                <span class="toolbar-icon">ðŸ“Ž</span>
                <span class="toolbar-text">Attach</span>
              </button>
              <div class="comment-hint">
                <span style="opacity: 0.6; font-size: 11px;">ðŸ’¡ Type @ to mention someone</span>
              </div>
              <div class="visibility-toggle">
                <input type="checkbox" id="commentInternal" />
                <label for="commentInternal" class="visibility-label">ðŸ”“ Public</label>
              </div>
            </div>

            <!-- MENTIONS DROPDOWN -->
            <div class="mentions-dropdown" id="mentionsDropdown">
              <input 
                type="text" 
                class="mentions-search" 
                id="mentionsSearch" 
                placeholder="Search users..."
              >
              <div class="mentions-list" id="mentionsList"></div>
            </div>

            <!-- ATTACHMENTS PREVIEW -->
            <div class="attachments-preview" id="attachmentsPreview">
              <div class="attachments-list" id="attachmentsList"></div>
            </div>

            <!-- COMMENT TEXTAREA -->
            <textarea 
              id="commentText" 
              class="comment-input" 
              placeholder="Add a comment... (Press Ctrl+Enter to post)"
              rows="4">
            </textarea>

            <!-- POST BUTTON -->
            <button class="btn-add-comment">Post Comment</button>
          </div>
        </div>

      </div>

      <!-- ACTIVITY PANEL (Hidden by default, switchable) -->
      <div class="sidebar-panel" id="activityPanel" style="display: none;">
        <div class="panel-header">
          <h3 class="panel-title">Activity</h3>
        </div>

        <div class="panel-content">
          <div class="activity-timeline" id="activityTimeline">
            <p class="no-activity">No activity yet</p>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- ===== FLOWING MVP FOOTER (Fixed at bottom) ===== -->
  <div id="flowingFooter" class="flowing-footer collapsed">
    <!-- Toggle Button -->
    <button id="flowingToggleBtn" class="flowing-toggle-btn" title="Flowing MVP Assistant">
      <span class="flowing-icon flowing-sf-logo">SF</span>
      <div class="flowing-info">
        <span class="flowing-label">Flowing MVP</span>
        <span class="flowing-suggestion" id="flowingSuggestion">Analyzing your queue...</span>
      </div>
      <span class="flowing-chevron">â–²</span>
    </button>

    <!-- Flowing Content -->
    <div class="flowing-content">
      <div class="flowing-header">
        <div class="flowing-title">
          <span class="flowing-avatar flowing-sf-logo">SF</span>
          <div class="flowing-title-text">
            <h3>Flowing MVP</h3>
            <p class="flowing-subtitle">Your AI assistant for tickets, SLAs, and smart suggestions</p>
          </div>
        </div>
        <button id="flowingCloseBtn" class="flowing-close-btn" title="Close">âœ•</button>
      </div>

      <!-- Messages Container -->
      <div id="flowingMessages" class="flowing-messages">
        <div class="flowing-message assistant">
          <div class="message-avatar flowing-sf-logo">SF</div>
          <div class="message-content">
            <p>ðŸ‘‹ Hi! I'm Flowing MVP, your SpeedyFlow Ticket Solving Mate! I can help you with:</p>
            <ul>
              <li>ðŸ“‹ Analyzing ticket priorities and patterns</li>
              <li>â±ï¸ Explaining SLA statuses and deadlines</li>
              <li>ðŸŽ¯ Suggesting next actions for tickets</li>
              <li>ðŸ“Š Providing insights on queue metrics</li>
            </ul>
            <p>Just ask me anything!</p>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="flowing-input-area">
        <div class="flowing-context-badge" id="flowingContextBadge">
          <span class="context-icon">ðŸ“Œ</span>
          <span class="context-text">No context</span>
        </div>
        <div class="flowing-input-wrapper">
          <textarea 
            id="flowingInput" 
            class="flowing-input" 
            placeholder="Ask me anything about your tickets..."
            rows="1"
          ></textarea>
          <button id="flowingSendBtn" class="flowing-send-btn" title="Send message">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ML PREDICTIVE DASHBOARD MODAL ===== -->
  <div id="ml-dashboard-modal" class="ml-dashboard-modal">
    <div class="ml-dashboard-container">
      <!-- Header -->
      <div class="ml-dashboard-header">
        <div class="ml-dashboard-title">
          <h2>ðŸŽ¯ ML Predictive Dashboard</h2>
          <div class="ml-dashboard-subtitle">Real-time insights powered by Machine Learning</div>
          <div class="ml-dashboard-data-source" id="ml-data-source-indicator">
            <span class="data-source-icon">ðŸ“Š</span>
            <span class="data-source-text">Loading...</span>
          </div>
        </div>
        <div class="ml-dashboard-controls">
          <button class="ml-dashboard-refresh" title="Refresh data">
            ðŸ”„ Refresh
          </button>
          <div class="ml-dashboard-auto-refresh-toggle">
            <input type="checkbox" id="ml-dashboard-auto-refresh" checked />
            <label for="ml-dashboard-auto-refresh">Auto-refresh</label>
          </div>
          <button class="ml-dashboard-close">âœ• Close</button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="ml-dashboard-tabs">
        <button class="ml-dashboard-tab active" data-tab="overview"><span class="ml-tab-icon" id="icon-ml-overview"></span> Overview</button>
        <button class="ml-dashboard-tab" data-tab="forecast"><span class="ml-tab-icon" id="icon-ml-forecast"></span> Breach Forecast</button>
        <button class="ml-dashboard-tab" data-tab="trends"><span class="ml-tab-icon" id="icon-ml-trends"></span> Performance</button>
        <button class="ml-dashboard-tab" data-tab="team"><span class="ml-tab-icon" id="icon-ml-team"></span> Team Workload</button>
      </div>

      <!-- Content -->
      <div class="ml-dashboard-content">
        <!-- Overview Tab -->
        <div class="ml-dashboard-tab-content active" data-tab="overview">
          <div class="metrics-grid">
            <div class="metric-card" data-metric="total-tickets">
              <span class="metric-value">-</span>
              <span class="metric-label">Total Tickets</span>
            </div>
            <div class="metric-card" data-metric="critical-tickets">
              <span class="metric-value">-</span>
              <span class="metric-label">Critical</span>
            </div>
            <div class="metric-card" data-metric="sla-compliance">
              <span class="metric-value">-</span>
              <span class="metric-label">SLA Compliance</span>
            </div>
            <div class="metric-card" data-metric="at-risk-tickets">
              <span class="metric-value">-</span>
              <span class="metric-label">At Risk</span>
            </div>
          </div>

          <div class="charts-grid">
            <div class="chart-container">
              <canvas id="sla-breakdown-chart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="priority-distribution-chart"></canvas>
            </div>
          </div>

          <h3 style="color: #f3f4f6; margin: 30px 0 15px;">âš ï¸ High-Risk Tickets</h3>
          <div id="breach-predictions-list"></div>
        </div>

        <!-- Breach Forecast Tab -->
        <div class="ml-dashboard-tab-content" data-tab="forecast">
          <div id="breach-forecast-content">
            <div class="ml-dashboard-loader">
              <div class="loader-spinner"></div>
              <div class="loader-text">Loading forecast...</div>
            </div>
          </div>
        </div>

        <!-- Performance Trends Tab -->
        <div class="ml-dashboard-tab-content" data-tab="trends">
          <div class="charts-grid">
            <div class="chart-container">
              <canvas id="ticket-volume-chart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="sla-compliance-chart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="resolution-time-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Team Workload Tab -->
        <div class="ml-dashboard-tab-content" data-tab="team">
          <div id="team-workload-content">
            <div class="ml-dashboard-loader">
              <div class="loader-spinner"></div>
              <div class="loader-text">Loading team data...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loader Overlay -->
      <div class="ml-dashboard-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="ml-loader-text">Loading dashboard...</div>
        <div class="loader-progress-container">
          <div class="loader-progress-bar" id="ml-loader-progress-bar"></div>
        </div>
        <div class="loader-percentage" id="ml-loader-percentage">0%</div>
      </div>
    </div>
  </div>

  <script>
    // Detectar usuario actual desde JIRA
    fetch('/api/user')
      .then(r => r.json())
      .then(data => {
        const user = data.displayName || data.name || 'You';
        localStorage.setItem('currentUser', user);
        localStorage.setItem('userFullName', data.displayName || 'John Doe');
        localStorage.setItem('userEmail', data.emailAddress || 'user@example.com');
      })
      .catch(() => {
        localStorage.setItem('currentUser', 'You');
        localStorage.setItem('userFullName', 'John Doe');
        localStorage.setItem('userEmail', 'user@example.com');
      });
  </script>
  
  <!-- ===== CORE APPLICATION SCRIPTS ===== -->
  <!-- Constants & Configuration (MUST load first) -->
  <script src="/static/js/constants/card-sizing.js"></script>
  
  <!-- SVG Icons Module - Centralized icon library -->
  <script src="/static/js/utils/svg-icons.js?v={{ timestamp }}"></script>
  
  <!-- Theme Manager - Centralized theme control -->
  <script src="/static/js/theme-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/sidebar-toggle.js?v={{ timestamp }}"></script>
  <script src="/static/js/sidebar-tooltip-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/sidebar-actions.js?v={{ timestamp }}"></script>
  <script src="/static/js/header-menu-controller.js?v={{ timestamp }}"></script>
  <script src="/static/js/right-sidebar.js?v={{ timestamp }}"></script>
  <script src="/static/js/mentions-system.js?v={{ timestamp }}"></script>
  <script src="/static/js/notifications-panel.js?v={{ timestamp }}"></script>
  <script src="/static/js/sla-monitor.js?v={{ timestamp }}"></script>
  
  <!-- ===== GLASSMORPHISM & TRANSPARENCY ===== -->
  <script src="/static/js/glassmorphism-opacity-controller.js?v={{ timestamp }}"></script>
  
  <!-- ===== BACKGROUND & AI EFFECTS ===== -->
  <script src="/static/js/background-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/background-selector-ui.js?v={{ timestamp }}"></script>
  
  <!-- ===== UI ENHANCEMENTS ===== -->
  <script src="/static/js/app.js?v={{ timestamp }}"></script>
  <script src="/static/js/auto-severity-config.js?v={{ timestamp }}"></script>
  <script src="/static/js/filter-bar-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/loading-state-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/loading-dots.js?v={{ timestamp }}"></script>

  <!-- ===== AI & ML MODULES ===== -->
  <script src="/static/js/modules/ai-queue-analyzer.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/view-toggle-filters.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/ai-field-suggestions.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/sidebar-inline-editor.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/ml-comment-suggestions.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/ml-anomaly-dashboard.js?v={{ timestamp }}"></script>

  <!-- ===== DRAG & DROP TRANSITIONS ===== -->
  <script src="/static/views/board/drag-transition-vertical.js?v={{ timestamp }}"></script>
  <script src="/static/views/list/list-view-transitions.js?v={{ timestamp }}"></script>
  
  <!-- ===== QUICK ACTIONS (Quick Triage & Smart Filters) ===== -->
  <script src="/static/js/quick-triage.js?v={{ timestamp }}"></script>
  <script src="/static/js/smart-filters.js?v={{ timestamp }}"></script>
  <script src="/static/js/smart-functions-modal.js?v={{ timestamp }}"></script>
  <script src="/static/js/smart-analytics.js?v={{ timestamp }}"></script>

  <!-- ===== FLOWING MVP ASSISTANT ===== -->
  <script src="/static/flowing-mvp/js/footer-assistant.js?v={{ timestamp }}"></script>
  <script src="/static/flowing-mvp/js/context-detector.js?v={{ timestamp }}"></script>

  <!-- ===== DIAGNOSTIC SCRIPT ===== -->
  <script>
    // Check if new comment elements are loaded
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const mentionBtn = document.getElementById('mentionBtn');
        const attachBtn = document.getElementById('attachBtn');
        const commentToolbar = document.querySelector('.comment-toolbar');
        
        console.log('=== Right Sidebar Diagnostic ===');
        console.log('âœ“ mentionBtn exists:', !!mentionBtn);
        console.log('âœ“ attachBtn exists:', !!attachBtn);
        console.log('âœ“ comment-toolbar exists:', !!commentToolbar);
        
        if (!mentionBtn) {
          console.warn('âš ï¸ mentionBtn NOT FOUND - check HTML structure');
        }
        if (!attachBtn) {
          console.warn('âš ï¸ attachBtn NOT FOUND - check HTML structure');
        }
        if (!commentToolbar) {
          console.warn('âš ï¸ comment-toolbar NOT FOUND - check CSS loading');
        }
        
        // Check if setupMentionSystem function exists
        console.log('âœ“ setupMentionSystem function exists:', typeof window.setupMentionSystem === 'function');
        console.log('âœ“ setupAttachmentsSystem function exists:', typeof window.setupAttachmentsSystem === 'function');
      }, 500);
    });
  </script>

  <!-- User Setup Modal -->
  <script src="/static/js/user-setup-modal.js?v={{ timestamp }}"></script>

  <!-- FOOTER V2 - ML Assistant -->
  <div id="footer-v2-root"></div>

  <!-- Footer V2 Scripts -->
  <script src="/static/js/footer-v2-bridge.js?v={{ timestamp }}"></script>
  <script src="/static/js/footer-v2.js?v={{ timestamp }}"></script>
</body>
</html>
