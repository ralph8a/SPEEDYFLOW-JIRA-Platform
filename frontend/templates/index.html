<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SpeedyFlow - JIRA Service Desk Integration Platform">
  <meta name="theme-color" content="#ffffff">
  <title>SpeedyFlow - Ticket Management</title>
  
  <!-- ============================================================
       CSS LOADING STRATEGY
       ============================================================
       1. Theme blocker loads first (prevents flash)
       2. app.bundle.css imports all production CSS in order:
          - Foundation (design tokens, variables, layout)
          - Themes (light/dark/transparency)
          - Components (UI elements)
          - Layout (structure)
          - Utilities (interactive features)
          - Fallback (legacy support)
       ============================================================ -->
  
  <!-- THEME BLOCKER: Prevents flash by applying theme BEFORE CSS renders -->
  <script src="/static/js/theme-blocker.js"></script>
  
  <!-- PRIMARY CSS BUNDLE: All production styles orchestrated -->
  <link rel="stylesheet" href="/static/css/app.bundle.css?v={{ timestamp }}">
  
  <!-- DRAG & DROP TRANSITIONS STYLING -->
  <link rel="stylesheet" href="/static/css/components/transition-bar-vertical.css?v={{ timestamp }}">
  
</head>
<body class="theme-light">
  <div class="app-container" role="application" aria-label="SpeedyFlow Ticket Workspace">
    <!-- SIDEBAR (UNIFIED REBUILD) -->
    <!-- SIDEBAR HEADER (Toggle Button) -->
    <aside class="sidebar-header-component" role="banner" aria-label="Sidebar Toggle">
      <button id="sidebarToggleBtn" class="sidebar-toggle-btn" aria-label="Toggle Sidebar">
        <span class="toggle-icon">‚ò∞</span>
      </button>
    </aside>

    <!-- SIDEBAR CONTENT (Navigation Menu) -->
    <aside class="sidebar-content-component" role="navigation" aria-label="Primary Navigation">
      <div class="sidebar-content">
        <section class="sidebar-section" aria-label="Navigation">
          <span class="sidebar-section-label">Navigation</span>
          <nav class="sidebar-menu" aria-label="Main">
            <button type="button" id="newTicketBtn" class="sidebar-menu-item" aria-label="Create Ticket"><span class="icon">‚úö</span><span class="label">Create Ticket</span></button>
            <a href="#" class="sidebar-menu-item active" aria-current="page"><span class="icon">üóÇÔ∏è</span><span class="label">My Tickets</span></a>
            <a href="#" class="sidebar-menu-item"><span class="icon">üìã</span><span class="label">All Tickets</span></a>
            <a href="#" class="sidebar-menu-item"><span class="icon">‚≠ê</span><span class="label">Starred</span></a>
          </nav>
        </section>
        <div class="sidebar-divider" aria-hidden="true"></div>
        <section class="sidebar-section" aria-label="Utilities">
          <span class="sidebar-section-label">Utilities</span>
          <nav class="sidebar-menu" aria-label="Utilities">
            <a href="#" class="sidebar-menu-item"><span class="icon">üîç</span><span class="label">Search</span></a>
            <a href="#" class="sidebar-menu-item"><span class="icon">üìä</span><span class="label">Reports</span></a>
            <button type="button" class="sidebar-menu-item" id="notificationsBtn" aria-label="Notifications"><span class="icon">üîî</span><span class="label">Notifications</span></button>
            <button type="button" class="sidebar-menu-item" id="refreshBtn" aria-label="Refresh"><span class="icon">üîÑ</span><span class="label">Refresh</span></button>
          </nav>
        </section>
        <div class="sidebar-divider" aria-hidden="true"></div>
        <section class="sidebar-section" aria-label="Account">
          <span class="sidebar-section-label">Account</span>
          <nav class="sidebar-menu" aria-label="Account">
            <a href="#" class="sidebar-menu-item"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a>
            <a href="#" class="sidebar-menu-item"><span class="icon">‚ùî</span><span class="label">Help Center</span></a>
            <button type="button" class="sidebar-menu-item" id="userMenuBtn" aria-label="User Menu" aria-haspopup="true" aria-expanded="false"><span class="icon">üë§</span><span class="label">Profile</span></button>
          </nav>
        </section>
      </div>
    </aside>

    <!-- MAIN WRAPPER -->
    <div class="main-wrapper" role="main">
      <!-- USER DROPDOWN (Hidden, shown on button click) -->
      <div class="user-dropdown" id="userDropdown" style="display:none" role="menu" aria-label="User Menu">
        <div class="user-dropdown-header"><span class="user-avatar-large">üë§</span><div class="user-info"><div class="user-full-name" id="userFullName">John Doe</div><div class="user-email" id="userEmail">john@example.com</div></div></div>
        <div class="user-dropdown-divider" aria-hidden="true"></div>
        <a href="#" class="user-dropdown-item" role="menuitem">üë§ My Profile</a>
        <a href="#" class="user-dropdown-item" role="menuitem">üîí Security</a>
        <a href="#" class="user-dropdown-item" role="menuitem">‚öôÔ∏è Preferences</a>
        <div class="user-dropdown-divider" aria-hidden="true"></div>
        <a href="#" class="user-dropdown-item" role="menuitem">üìû Support</a>
        <a href="#" class="user-dropdown-item" role="menuitem">üìò Docs</a>
        <div class="user-dropdown-divider" aria-hidden="true"></div>
        <button id="logoutBtn" class="user-dropdown-item logout" role="menuitem">üö™ Logout</button>
      </div>

      <header class="header-enhanced" aria-label="Primary">
        <div class="header-left-section">
          <div class="header-brand">
            <span class="brand-icon">‚ö°</span>
            <span class="brand-text">SpeedyFlow</span>
          </div>
          <div class="header-divider-vertical"></div>
          <h1 class="header-page-title">
            <span class="page-title-text">Tickets</span>
          </h1>
        </div>
        
        <div class="header-center-section">
          <nav aria-label="Breadcrumb" class="breadcrumb-enhanced">
            <span class="breadcrumb-item" id="deskBreadcrumb">Select Desk</span>
            <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
            <span class="breadcrumb-item" id="queueBreadcrumb">Select Queue</span>
          </nav>
        </div>
        
        <div class="header-right-section">
          <button id="mlAnalyzeBtn" class="header-action-btn" title="Analyze with ML">
            <span class="header-btn-icon">ü§ñ</span>
            <span class="header-btn-text">Analyze ML</span>
          </button>
          <div class="header-status-badge">
            <span class="status-indicator"></span>
            <span class="status-text" id="filterStatus">Ready</span>
          </div>
        </div>
      </header>

      <div class="filter-bar-enhanced" aria-label="Filters">
        <!-- Primary Filters -->
        <div class="filter-section filter-primary">
            <div class="filter-group">
              <label for="serviceDeskSelectFilter" class="filter-label">
                <span class="filter-icon">üè¢</span>
                <span class="filter-text">Service Desk</span>
              </label>
              <div class="filter-input-wrapper">
                <select id="serviceDeskSelectFilter" class="filter-select">
                  <option value="">Select Desk...</option>
                </select>
                <span class="filter-dropdown-icon">‚ñº</span>
              </div>
            </div>
            
            <div class="filter-group">
              <label for="queueSelectFilter" class="filter-label">
                <span class="filter-icon">üìã</span>
                <span class="filter-text">Queue</span>
              </label>
              <div class="filter-input-wrapper filter-with-action">
                <select id="queueSelectFilter" class="filter-select">
                  <option value="">Select Queue...</option>
                </select>
                <span class="filter-dropdown-icon">‚ñº</span>
                <button id="saveFiltersBtn" class="filter-action-btn" title="Save current filters">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H7V5h8v4z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="filter-divider"></div>

          <!-- View Controls -->
          <div class="filter-section filter-controls">
            <div class="filter-group">
              <label class="filter-label">
                <span class="filter-icon">üëÅÔ∏è</span>
                <span class="filter-text">View Mode</span>
              </label>
              <div class="view-toggle-enhanced" role="tablist">
                <button class="view-btn active" data-view="kanban" aria-selected="true" role="tab">
                  <span class="view-icon">üìä</span>
                  <span class="view-text">Board</span>
                </button>
                <button class="view-btn" data-view="list" role="tab">
                  <span class="view-icon">üìù</span>
                  <span class="view-text">List</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="filter-divider"></div>

          <!-- Theme Controls -->
          <div class="filter-section filter-theme">
            <div class="filter-group">
              <label class="filter-label">
                <span class="filter-icon">‚ú®</span>
                <span class="filter-text">Customize</span>
              </label>
              <div class="theme-controls">
                <button id="bgSelectorHeaderBtn" class="theme-btn" title="Change background">
                  <span class="theme-btn-icon">üé®</span>
                  <span class="theme-btn-text">Background</span>
                </button>
                <button id="themeToggleBtn" class="theme-btn" title="Toggle theme">
                  <span class="theme-btn-icon">üé≠</span>
                  <span class="theme-btn-text">Theme</span>
                </button>
              </div>
            </div>
          </div>
        </div>

      <div class="board-wrapper" id="boardWrapper">
        <div id="kanbanView" class="kanban-board" aria-live="polite">
          <div class="placeholder-pro" id="kanbanPlaceholder">Loading tickets...</div>
        </div>
        <div id="listView" class="list-view" style="display:none" aria-live="polite">
          <div class="placeholder-pro" id="listPlaceholder">Loading tickets...</div>
        </div>
      </div>

      <!-- RIGHT SIDEBAR (TICKET DETAILS) -->
      <div class="right-sidebar" id="rightSidebar" style="display: none;">
      <!-- CLOSE BUTTON -->
      <button class="btn-close-sidebar" id="closeSidebarBtn">‚úï</button>

      <!-- TWO COLUMN LAYOUT -->
      <div class="sidebar-two-columns">
        
        <!-- LEFT COLUMN: DETAILS -->
        <div class="sidebar-column sidebar-details">
          <div class="column-header">
            <h3>Ticket Details</h3>
          </div>

          <div class="column-content">
            <!-- ISSUE KEY -->
            <div class="detail-group">
              <div class="detail-label">Key</div>
              <div class="detail-value" id="detailKey">‚Äî</div>
            </div>

            <!-- SUMMARY -->
            <div class="detail-group">
              <div class="detail-label">Summary</div>
              <div class="detail-value detail-summary" id="detailSummary">‚Äî</div>
            </div>

            <!-- STATUS -->
            <div class="detail-group">
              <div class="detail-label">Status</div>
              <div class="detail-value">
                <span class="status-badge" id="detailStatus">Unknown</span>
              </div>
            </div>

            <!-- SEVERITY -->
            <div class="detail-group">
              <div class="detail-label">Severity</div>
              <div class="detail-value">
                <span class="severity-badge" id="detailSeverity">Normal</span>
              </div>
            </div>

            <!-- ASSIGNEE -->
            <div class="detail-group">
              <div class="detail-label">Assigned To</div>
              <div class="detail-value" id="detailAssignee">Unassigned</div>
            </div>

            <!-- REPORTER (Who created the ticket) -->
            <div class="detail-group">
              <div class="detail-label">Reporter</div>
              <div class="reporter-card" id="detailReporter">
                <div class="reporter-placeholder">‚Äî</div>
              </div>
            </div>

            <!-- TYPE -->
            <div class="detail-group">
              <div class="detail-label">Type</div>
              <div class="detail-value" id="detailType">‚Äî</div>
            </div>

            <!-- CREATED -->
            <div class="detail-group">
              <div class="detail-label">Created</div>
              <div class="detail-value detail-date" id="detailCreated">‚Äî</div>
            </div>

            <!-- UPDATED -->
            <div class="detail-group">
              <div class="detail-label">Updated</div>
              <div class="detail-value detail-date" id="detailUpdated">‚Äî</div>
            </div>

            <!-- DESCRIPTION -->
            <div class="detail-group">
              <div class="detail-label">Description</div>
              <div class="detail-value detail-description" id="detailDescription">‚Äî</div>
            </div>

            <!-- ALL FIELDS SECTION (DYNAMIC) -->
            <div class="detail-group detail-group-all-fields">
              <div class="detail-label">
                <span>üìã All Fields</span>
                <span class="detail-label-hint">(All ticket data)</span>
              </div>
              <div id="allFieldsContainer" class="all-fields-container">
                <!-- Populated dynamically by right-sidebar.js -->
              </div>
            </div>

            <!-- SLA MONITOR CONTAINER -->
            <div id="slaMonitorContainer" class="sidebar-feature-container">
              <!-- SLA Monitor se renderiza aqu√≠ din√°micamente -->
            </div>

            <!-- TICKET PORTAL FORMS CONTAINER -->
            <div id="ticketPortalFormsContainer" class="sidebar-feature-container">
              <!-- Ticket Portal Forms se renderiza aqu√≠ din√°micamente -->
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN: COMMENTS -->
        <div class="sidebar-column sidebar-comments">
          <div class="column-header">
            <h3>Comments <span class="comment-count" id="commentCount">(0)</span></h3>
          </div>

          <div class="column-content">
            <div class="comments-list" id="commentsList">
              <p class="no-comments">Loading comments...</p>
            </div>
          </div>

          <!-- COMMENT INPUT AREA -->
          <div class="comment-input-container">
            <!-- MENTIONS & ATTACHMENTS TOOLBAR -->
            <div class="comment-toolbar">
              <button class="comment-toolbar-btn" id="mentionBtn" title="@Mention someone">
                <span class="toolbar-icon">@</span>
                <span class="toolbar-text">Mention</span>
              </button>
              <button class="comment-toolbar-btn" id="attachBtn" title="Attach file">
                <span class="toolbar-icon">üìé</span>
                <span class="toolbar-text">Attach</span>
              </button>
              <div class="visibility-toggle">
                <input type="checkbox" id="commentInternal" />
                <label for="commentInternal" class="visibility-label">üîì Public</label>
              </div>
            </div>

            <!-- MENTIONS DROPDOWN -->
            <div class="mentions-dropdown" id="mentionsDropdown">
              <input 
                type="text" 
                class="mentions-search" 
                id="mentionsSearch" 
                placeholder="Search users..."
              >
              <div class="mentions-list" id="mentionsList"></div>
            </div>

            <!-- ATTACHMENTS PREVIEW -->
            <div class="attachments-preview" id="attachmentsPreview">
              <div class="attachments-list" id="attachmentsList"></div>
            </div>

            <!-- COMMENT TEXTAREA -->
            <textarea 
              id="commentText" 
              class="comment-input" 
              placeholder="Add a comment... (Press Ctrl+Enter to post)"
              rows="4">
            </textarea>

            <!-- POST BUTTON -->
            <button class="btn-add-comment">Post Comment</button>
          </div>
        </div>

      </div>

      <!-- ACTIVITY PANEL (Hidden by default, switchable) -->
      <div class="sidebar-panel" id="activityPanel" style="display: none;">
        <div class="panel-header">
          <h3 class="panel-title">Activity</h3>
        </div>

        <div class="panel-content">
          <div class="activity-timeline" id="activityTimeline">
            <p class="no-activity">No activity yet</p>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <script>
    // Detectar usuario actual desde JIRA
    fetch('/api/user')
      .then(r => r.json())
      .then(data => {
        const user = data.displayName || data.name || 'You';
        localStorage.setItem('currentUser', user);
        localStorage.setItem('userFullName', data.displayName || 'John Doe');
        localStorage.setItem('userEmail', data.emailAddress || 'user@example.com');
      })
      .catch(() => {
        localStorage.setItem('currentUser', 'You');
        localStorage.setItem('userFullName', 'John Doe');
        localStorage.setItem('userEmail', 'user@example.com');
      });
  </script>
  
  <!-- ===== CORE APPLICATION SCRIPTS ===== -->
  <!-- Constants & Configuration (MUST load first) -->
  <script src="/static/js/constants/card-sizing.js"></script>
  
  <!-- Theme Manager - Centralized theme control -->
  <script src="/static/js/theme-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/sidebar-toggle.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/sidebar-actions.js?v={{ timestamp }}"></script>
  <script src="/static/js/floating-controls.js?v={{ timestamp }}"></script>
  <script src="/static/js/right-sidebar.js?v={{ timestamp }}"></script>
  <script src="/static/js/mentions-system.js?v={{ timestamp }}"></script>
  <script src="/static/js/sla-monitor.js?v={{ timestamp }}"></script>
  
  <!-- ===== GLASSMORPHISM & TRANSPARENCY ===== -->
  <script src="/static/js/transparency-manager.js?v={{ timestamp }}"></script>
  
  <!-- ===== BACKGROUND & AI EFFECTS ===== -->
  <script src="/static/js/background-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/background-selector-ui.js?v={{ timestamp }}"></script>
  
  <!-- ===== UI ENHANCEMENTS ===== -->
  <!-- Disabled: floating-theme-button.js - Theme button now integrated in sidebar -->
  <script src="/static/js/app.js?v={{ timestamp }}"></script>
  <script src="/static/js/auto-severity-config.js?v={{ timestamp }}"></script>
  <script src="/static/js/layout-manager.js?v={{ timestamp }}"></script>
  <script src="/static/js/state-indicators.js?v={{ timestamp }}"></script>
  <script src="/static/js/loading-dots.js?v={{ timestamp }}"></script>

  <!-- ===== AI & ML MODULES ===== -->
  <script src="/static/js/modules/ai-queue-analyzer.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/view-toggle-filters.js?v={{ timestamp }}"></script>
  <script src="/static/js/modules/ai-field-suggestions.js?v={{ timestamp }}"></script>

  <!-- ===== DRAG & DROP TRANSITIONS ===== -->
  <script src="/static/js/modules/drag-transition-vertical.js?v={{ timestamp }}"></script>

  <!-- ===== DIAGNOSTIC SCRIPT ===== -->
  <script>
    // Check if new comment elements are loaded
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const mentionBtn = document.getElementById('mentionBtn');
        const attachBtn = document.getElementById('attachBtn');
        const commentToolbar = document.querySelector('.comment-toolbar');
        
        console.log('=== Right Sidebar Diagnostic ===');
        console.log('‚úì mentionBtn exists:', !!mentionBtn);
        console.log('‚úì attachBtn exists:', !!attachBtn);
        console.log('‚úì comment-toolbar exists:', !!commentToolbar);
        
        if (!mentionBtn) {
          console.warn('‚ö†Ô∏è mentionBtn NOT FOUND - check HTML structure');
        }
        if (!attachBtn) {
          console.warn('‚ö†Ô∏è attachBtn NOT FOUND - check HTML structure');
        }
        if (!commentToolbar) {
          console.warn('‚ö†Ô∏è comment-toolbar NOT FOUND - check CSS loading');
        }
        
        // Check if setupMentionSystem function exists
        console.log('‚úì setupMentionSystem function exists:', typeof window.setupMentionSystem === 'function');
        console.log('‚úì setupAttachmentsSystem function exists:', typeof window.setupAttachmentsSystem === 'function');
      }, 500);
    });
  </script>
</body>
</html>
